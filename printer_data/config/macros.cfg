###############################################################
#                 PRINT_START - START DRUKU                   #
###############################################################
# Wywo≈Çanie w slicerze (Start G-code):
# PRINT_START BED=[first_layer_bed_temperature] EXTRUDER=[first_layer_temperature]
#
# Prusa/Super/OrcaSlicer:
# PRINT_START BED=[first_layer_bed_temperature] EXTRUDER=[first_layer_temperature]
###############################################################

[gcode_macro PRINT_START]
description: Procedura startowa dla Ender 5 + BLTouch
gcode:
    LED_HEATING
    {% set BED = params.BED|default(60)|float %}
    {% set EXTRUDER = params.EXTRUDER|default(200)|float %}

    # Tryby pracy
    G90                     ; absolutne X/Y/Z
    M83                     ; ekstruzja wzglƒôdna

    # Wstƒôpne grzanie
    M140 S{BED}             ; rozpocznij grzanie sto≈Çu (bez czekania)
    M104 S150               ; wstƒôpne grzanie hotendu (anty-ooze)
    G4 S5                   ; chwila na z≈Çapanie temperatury

    # Homing (u Ciebie dzia≈Ça przez [safe_z_home])
    G28                     ; home wszystkich osi

    # Podniesienie g≈Çowicy
    G1 Z10 F600

    # Wczytanie zapisanej siatki sto≈Çu (profil "default" z SAVE_CONFIG)
    # BED_MESH_PROFILE LOAD=default
    # üëâ ZAMIANA: zamiast wczytywaƒá profil, kalibruj
    BED_MESH_CLEAR          ; wyczy≈õƒá starƒÖ siatkƒô (opcjonalne, ale ≈Çadnie)
    BED_MESH_CALIBRATE      ; pe≈Çne sondowanie sto≈Çu BLTouchem

    # Po kalibracji Klipper ma ju≈º aktywnƒÖ nowƒÖ siatkƒô
    
    LED_PRINTING
    # Dogrzanie do docelowych temperatur
    M190 S{BED}             ; czekaj na st√≥≈Ç
    M109 S{EXTRUDER}        ; czekaj na hotend

    # Pozycja startowa do purge line
    # USTAWIONE WEWNƒÑTRZ OBSZARU MESH:
    # mesh_min: 20,20  mesh_max: 180,220
    G1 X25 Y25 F6000        ; lewy prz√≥d, wewnƒÖtrz zmapowanej siatki
    G1 Z0.3 F300            ; wysoko≈õƒá pierwszej warstwy (lekko nad)

    # Purge line - wype≈Çnienie i oczyszczenie dyszy
    G92 E0
    G1 E5 F300              ; wypchnij trochƒô filamentu
    G1 X180 E15 F600        ; linia wzd≈Çu≈º X w obszarze zmapowanym
    G1 Z2 F300
    G92 E0                  ; wyzeruj licznik E przed startem modelu






###############################################################
#                 PRINT_END - KONIEC DRUKU                    #
###############################################################
# Wywo≈Çanie w slicerze (End G-code):
# PRINT_END
###############################################################

[gcode_macro PRINT_END]
description: Procedura zako≈Ñczenia druku
gcode:
    SAVE_GCODE_STATE NAME=PRINT_END_state
    LED_IDLE
    # Ma≈Ça retrakcja
    G92 E0
    G1 E-2 F2400            ; cofnij filament, ≈ºeby nie kapa≈Ço

    # Bezpieczne podniesienie Z (o 10 mm, o ile jeste≈õmy poni≈ºej 290 mm)
    {% if printer.toolhead.position.z < 290 %}
      G1 Z{printer.toolhead.position.z + 10} F600
    {% endif %}

    # Parking - lewy ty≈Ç sto≈Çu (bezpiecznie w zakresie X/Y)
    # Masz: X max 230, Y max 235 -> tu zostawiamy margines
    G1 X10 Y225 F6000

    # Wy≈ÇƒÖczenie grzania
    M104 S0                 ; hotend off
    M140 S0                 ; bed off

    # Chwilƒô przedmuchaj model i g≈Çowicƒô
    G4 S10
    M106 S0                 ; wentylator wydruku off

    # Wy≈ÇƒÖcz silniki
    M84

    RESTORE_GCODE_STATE NAME=PRINT_END_state





###############################################################
#                    MAKRA POMOCNICZE                         #
###############################################################

# Szybki test BLTouch - wysuniƒôcie i schowanie pinu
[gcode_macro TEST_BLTOUCH]
description: Test dzia≈Çania BLTouch (pin up/down)
gcode:
    G28
    BLTOUCH_DEBUG COMMAND=pin_down
    G4 S2
    BLTOUCH_DEBUG COMMAND=pin_up

# Kalibracja Z-offset dla BLTouch
[gcode_macro Z_OFFSET_CALIBRATE]
description: Start kalibracji Z-offset dla BLTouch
gcode:
    G28
    PROBE_CALIBRATE

# Rƒôczne rozgrzanie do wymiany filamentu
[gcode_macro HEAT_FOR_CHANGE]
description: Rozgrzanie hotendu do zmiany filamentu
gcode:
    M104 S200
    M109 S200

# Prosta makra pauzy/wznowienia (je≈õli nie u≈ºywasz domy≈õlnych)
[gcode_macro PAUSE]
description: Pauza druku
gcode:
    SAVE_GCODE_STATE NAME=PAUSE_state
    G91
    G1 Z10 F600             ; podnie≈õ g≈Çowicƒô
    G90
    G1 X10 Y215 F6000       ; odjed≈∫ na ty≈Ç
    M84 E                   ; wy≈ÇƒÖcz tylko ekstruder

[gcode_macro RESUME]
description: Wznowienie druku
gcode:
    RESTORE_GCODE_STATE NAME=PAUSE_state



[gcode_macro NOTIFY_PRINT_DONE]
gcode:
    {action_call_remote_method(
        "notify",
        name="pushover_print",
        message="Druk zako≈Ñczony ‚úÖ"
    )}
    


###############################################################
#                    NeoPixel                                 #
###############################################################


[gcode_macro LED_IDLE]
gcode:
    SET_LED LED=status_leds RED=0 GREEN=0 BLUE=0

[gcode_macro LED_HEATING]
gcode:
    SET_LED LED=status_leds RED=1 GREEN=0.3 BLUE=0

[gcode_macro LED_PRINTING]
gcode:
    SET_LED LED=status_leds RED=1 GREEN=1 BLUE=1 WHITE=1

[gcode_macro LED_ERROR]
gcode:
    SET_LED LED=status_leds RED=1 GREEN=0 BLUE=0

